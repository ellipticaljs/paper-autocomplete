<!doctype html>

<html>
<head>
  <title>Paper-autocomplete test</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>
  <link rel="import" href="../paper-autocomplete.html">
</head>
<body>

<test-fixture id="basic">
  <template>
    <paper-autocomplete label="Select User" id="input-remote" remote-source="true" min-length="2" required></paper-autocomplete>
  </template>
</test-fixture>
<script>
  describe('paper-autocomplete', function() {
    var element;

    beforeEach(function(done) {
      element = fixture('basic');

      document.querySelector('#input-remote').addEventListener('autocomplete-selected', onSelect);
      document.querySelector('#input-remote').addEventListener('autocomplete-change', onChange);

      function onSelect(event) {
        var paperToast = document.querySelector('paper-toast');
        var selected = event.detail.text;
        paperToast.text = 'Selected: ' + selected;
        paperToast.show();
      }

      function onChange(event) {
        var input = document.querySelector('#input-remote');
        var search = event.detail.option.text;
        var url = 'https://api.github.com/search/users?q=' + search + '+in:login';
        var req = new XMLHttpRequest();
        req.open('GET', encodeURI(url));
        req.onload = function () {
          if (req.status === 200) {
            var data = JSON.parse(req.response);
            var arr = data.items.map(function (obj) {
              return {text: obj.login, value: obj.login};
            });
            input.suggestions(arr);
          }
        };
        req.send();
      }
      done();

      this.xhr = sinon.useFakeXMLHttpRequest();

      this.requests = [];
      this.xhr.onCreate = function(xhr) {
        this.requests.push(xhr);
      }.bind(this);
    });

    afterEach(function() {
      this.xhr.restore();
    });

    describe('Test remote call', function() {
      it('should parse fetched data as JSON', function(done) {
        var data = { text: 'bart', value: 'bart' };
        var dataJson = JSON.stringify(data);
//        var stubEvent = {
//          detail:{
//            option: {
//              text: "bart"
//            }
//          }
//        };
//        var inputRemote = document.querySelector('#input-remote');
//        console.log(inputRemote);
//        enterCharacter(inputRemote, 'A');
//        enterCharacter(inputRemote, 'l');
//        Polymer.dom.flush();

//        onChange(stubEvent);
        onChange().open(function(err, result) {
          result.should.deep.equal(data);
          done();
        });

        this.requests[0].respond(200, { 'Content-Type': 'text/json' }, dataJson);
      });
    });
    function enterCharacter(input, char) {
      input.value += char;
      MockInteractions.keyUpOn(input, char.charCodeAt(char.length - 1));
    }
//    // a11ySuite('basic');
  });
</script>

</body>
</html>
